name: Train and Deploy

on:
  push:
    branches: [ "main" ]

jobs:
  run-pipeline:
    runs-on: ubuntu-latest

    steps:
      # 1. Check out code
      - uses: actions/checkout@v4

      # 2. Authenticate to Google Cloud
      # This step creates a temporary credentials file from your Secret
      # and sets GOOGLE_APPLICATION_CREDENTIALS env var automatically.
      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      # 3. Setup Python & DVC
      - name: Install dependencies
        run: |
          pip install dvc dvc-gs
          pip install -r requirements.txt

      # 4. Pull Data (DVC automatically sees the auth from Step 2)
      - name: Pull Data
        run: dvc pull

      # 5. Build & Push Docker Image (Optional)
      - name: Build Docker
        run: |
          gcloud auth configure-docker
          docker build -t gcr.io/my-project/my-image:latest .
          docker push gcr.io/my-project/my-image:latest