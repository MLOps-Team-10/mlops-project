# 1. Define Service Account (Global)
serviceAccount: "projects/mlops-exercises-484210/serviceAccounts/bucket-manager@mlops-exercises-484210.iam.gserviceaccount.com"

# 2. Define Steps (YOU WERE MISSING THIS KEYWORD)
steps:
  - name: "alpine"
    id: "Replace values in the training config"
    entrypoint: "sh"
    args:
      - '-c'
      - |
        apk add --no-cache gettext
        # Modifying config_gpu.yaml directly
        envsubst < cloud_deploy/config_gpu.yaml > cloud_deploy/config_gpu.yaml.tmp
        mv cloud_deploy/config_gpu.yaml.tmp cloud_deploy/config_gpu.yaml
    secretEnv: ['WANDB_API_KEY']

  - name: 'alpine'
    id: "Show config"
    waitFor: ['Replace values in the training config']
    entrypoint: "sh"
    args:
      - '-c'
      # FIX: cat config_gpu.yaml (the file you changed), not config.yaml
      - |
        cat cloud_deploy/config_gpu.yaml

  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'Train on vertex AI'
    waitFor: ['Replace values in the training config']
    args: [
      'ai',
      'custom-jobs',
      'create',
      '--region',
      'europe-west1',
      '--display-name',
      'GPU-Cloud-storage-and-saving',
      '--service-account',
      'bucket-manager@mlops-exercises-484210.iam.gserviceaccount.com',
      '--config',
      '${_VERTEX_TRAIN_CONFIG}',
    ]

substitutions:
  _VERTEX_TRAIN_CONFIG: 'cloud_deploy/config_gpu.yaml'

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/WANDB_API_KEY/versions/latest
    env: 'WANDB_API_KEY'

options:
  logging: CLOUD_LOGGING_ONLY